<!DOCTYPE html>
<html>
<head>
  <title>Site and Date Selector</title>
  <style>
    .intro-text {
      font-size: 1rem; /* Slightly larger font size for readability */
      line-height: 1.8; /* Increase line height for better spacing */
      color: #333; /* Use a dark text color for readability */
      text-align: left; /* Align the text to the left for readability */
      width: 100%; /* Make the text container span the full width of the page */
      padding: 25px; /* Add padding inside the bar */
      background-color: #f8f9fa; /* Use a light neutral background color */
      border: 1px solid #ddd; /* Add a subtle border for definition */
      border-radius: 8px; /* Add rounded corners for a modern look */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Add a soft shadow for depth */
      margin-bottom: 20px; /* Add spacing below the intro text */
      box-sizing: border-box; /* Ensure padding is included in height calculation */
    }

    body {
      margin: 0; /* Remove default margin */
      padding: 0; /* Remove default padding */
      font-family: Arial, sans-serif; /* Set a clean font */
      box-sizing: border-box; /* Ensure consistent sizing */
    }

    #form-container {
      width: 90%; /* Make the form container responsive */
      max-width: 1200px; /* Limit the maximum width */
      margin: 20px auto; /* Center the form container */
    }

    .checkbox-group {
      margin-top: 20px; /* Add spacing above the checkboxes */
      margin-bottom: 20px; /* Add spacing below the checkboxes */
    }

    .checkbox-group label {
      display: block;
      margin-bottom: 5px;
    }

    #submit-button, #download-button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    #submit-button:disabled, #download-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    #download-button {
      background-color: #28a745;
      display: none;
    }

    #processing {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
    }

    #results {
      margin-top: 20px;
      width: 100%;
      max-width: 95vw;
      display: none;
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 10px;
    }

    #results table {
      width: 100%;
      min-width: 800px;
      border-collapse: collapse;
      font-size: 14px;
    }

    #results th, #results td {
      border: 1px solid #ddd;
      padding: 12px 8px;
      text-align: left;
      word-wrap: break-word;
    }

    #results th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    #results td:nth-child(1) { /* Site column */
      width: 100px;
      min-width: 100px;
    }

    #results td:nth-child(2) { /* URL column */
      width: 60%;
      max-width: 400px;
      word-break: break-all;
    }

    #results td:nth-child(3) { /* Last Modified column */
      width: 150px;
      min-width: 150px;
    }

    #results tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    #results tr:hover {
      background-color: #f5f5f5;
    }

    #results a {
      color: #007bff;
      text-decoration: none;
    }

    #results a:hover {
      text-decoration: underline;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
      gap: 10px;
    }

    .pagination button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background-color: white;
      cursor: pointer;
      border-radius: 4px;
    }

    .pagination button:hover:not(:disabled) {
      background-color: #f5f5f5;
    }

    .pagination button:disabled {
      background-color: #f5f5f5;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .pagination .current-page {
      background-color: #007bff;
      color: white;
    }

    .pagination-info {
      margin: 0 15px;
      font-size: 14px;
      color: #666;
    }

    .results-summary {
      margin-bottom: 15px;
      padding: 10px;
      background-color: #e7f3ff;
      border: 1px solid #b3d7ff;
      border-radius: 4px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 2s linear infinite;
      display: inline-block;
      margin-right: 10px;
    }
    
    #date-picker {
      margin-bottom: 30px; /* Increased space below date picker */
    }

    #date-picker label {
      display: block;
      margin-bottom: 8px; /* Space between label and input */
      font-weight: bold;
    }

    #as-of-date {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      width: 200px;
      margin-bottom: 15px; /* Extra space below date input */
    }

    .button-group {
      margin-top: 20px; /* Extra space above buttons */
    }
    #submit-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    #submit-button:disabled:hover {
      background-color: #ccc; /* Ensure it stays grey on hover */
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      body { padding: 10px; }
      #results { max-width: 100vw; }
      .pagination { flex-wrap: wrap; }
      .pagination-info { margin: 5px 0; }
    }
  </style>
</head>
<body>
  <p class="intro-text"> Everyday, Department of Homeland Security websites are quietly changing, as policies are updated or revoked with little to no notice give to the public.
    This tool allows reporters to monitor changes to these websites in real time, making edits visible and auditable. 
    It surfaces URLs from across the department that have recently been updated, making it possible to quickly identify new policies, track revisions, and ensure transparency by holding DHS accountable for its online content.

    Select one or more sites below to view all URLs updated as of a specific date.
    For example, to see all ICE site URLs updated since July 2025, select "ICE" and enter "07/01/2025" in the "As of Date" field, then click "Submit" to generate the results.
  </p>
  <div id="form-container">
    <h3>DHS Site Search</h3>
    <p>Select one or more sites to view a list of all changed pages</p>
    <form id="site-form">
      <div class="checkbox-group">
        <label><input type="checkbox" name="site" value="ice.gov"> ICE</label>
        <label><input type="checkbox" name="site" value="cbp.gov"> CBP</label>
        <label><input type="checkbox" name="site" value="fema.gov"> FEMA</label>
        <label><input type="checkbox" name="site" value="fletc.gov"> FLETC</label>
        <label><input type="checkbox" name="site" value="tsa.gov"> TSA</label>
        <label><input type="checkbox" name="site" value="uscis.gov"> USCIS</label>
        <label><input type="checkbox" name="site" value="DHS.gov"> DHS</label>
      </div>
      <div id="date-picker">
        <label for="as-of-date">As of Date (optional):</label>
        <input type="date" id="as-of-date" name="as-of-date" max="">
      </div>
      <div class="button-group">
        <button type="button" id="submit-button">Submit</button>
        <button type="button" id="download-button">Download CSV</button>
      </div>
    </form>

    <div id="processing">
      <div class="spinner"></div>
      Processing sitemaps
    </div>
  </div>

  <div id="results">
    
    <div class="results-summary" id="results-summary"></div>
    <div id="hide-unknown-container" style="display: none; margin-top: 10px;">
      <label>
        <input type="checkbox" id="hide-unknown" />
        Hide results with unknown "Last Modified" date
      </label>
    </div>
    <div class="pagination" id="pagination-top">
      <button id="first-page">First</button>
      <button id="prev-page">Previous</button>
      <div class="pagination-info" id="page-info"></div>
      <button id="next-page">Next</button>
      <button id="last-page">Last</button>
    </div>

    <div class="table-container">
      <table id="results-table">
        <thead>
          <tr>
            <th>Site</th>
            <th>URL</th>
            <th>Last Modified</th>
          </tr>
        </thead>
        <tbody id="results-body">
        </tbody>
      </table>
    </div>

    <div class="pagination" id="pagination-bottom">
      <button id="first-page-bottom">First</button>
      <button id="prev-page-bottom">Previous</button>
      <div class="pagination-info" id="page-info-bottom"></div>
      <button id="next-page-bottom">Next</button>
      <button id="last-page-bottom">Last</button>
    </div>
  </div>

  <script>
    let currentResults = null;
    let currentPage = 1;
    let itemsPerPage = 50;
    let totalPages = 1;

    // Function to check if any sites are selected and update submit button state
    function updateSubmitButtonState() {
      const selectedSites = document.querySelectorAll('input[name="site"]:checked');
      const submitButton = document.getElementById('submit-button');
      
      if (selectedSites.length === 0) {
        submitButton.disabled = true;
        submitButton.style.opacity = '0.6';
        submitButton.title = 'Please select at least one site';
      } else {
        submitButton.disabled = false;
        submitButton.style.opacity = '1';
        submitButton.title = '';
      }
    }

    // Set max date to today and initial button state
    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date().toLocaleDateString('en-CA', {
        timeZone: 'America/New_York'
      });
      document.getElementById('as-of-date').setAttribute('max', today);
      
      // Set initial state (disabled since nothing is selected)
      updateSubmitButtonState();
      
      // Add event listeners to all checkboxes
      document.querySelectorAll('input[name="site"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateSubmitButtonState);
      });
    });

    document.getElementById("submit-button").addEventListener("click", function () {
      const selectedSites = Array.from(document.querySelectorAll('input[name="site"]:checked')).map(input => input.value);
      const asOfDate = document.getElementById("as-of-date").value;

      // This check is now redundant since button is disabled, but keeping for safety
      if (selectedSites.length === 0) {
        alert("Please select at least one site.");
        return;
      }

      // Show processing indicator
      document.getElementById("processing").style.display = "block";
      document.getElementById("results").style.display = "none";
      document.getElementById("download-button").style.display = "none";
      document.getElementById("submit-button").disabled = true;
      document.getElementById("submit-button").textContent = "Processing...";

      // Send request to backend
      fetch('/process-sites', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          sites: selectedSites,
          asOfDate: asOfDate || null,
        }),
      })
      .then(response => {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error('Network response was not ok');
        }
      })
      .then(data => {
        currentResults = data;
        currentPage = 1;
        displayResults(data);
        
        // Hide processing indicator and restore button state
        document.getElementById("processing").style.display = "none";
        document.getElementById("submit-button").textContent = "Submit";
        updateSubmitButtonState(); // This will re-enable if sites are still selected
        document.getElementById("download-button").style.display = "inline-block";
      })
      .catch(error => {
        console.error("Error:", error);
        alert("An error occurred while processing the request.");
        
        // Hide processing indicator and restore button state
        document.getElementById("processing").style.display = "none";
        document.getElementById("submit-button").textContent = "Submit";
        updateSubmitButtonState(); // This will re-enable if sites are still selected
      });
    });

    document.getElementById("download-button").addEventListener("click", function () {
      if (!currentResults) {
        alert("No results to download.");
        return;
      }

      // Generate CSV content
      let csvContent = "Site,URL,Last Modified\n";
      currentResults.forEach(row => {
        csvContent += `"${row.site}","${row.url}","${row.lastmod}"\n`;
      });

      // Create download
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = `sitemap_links_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
    });

    // Pagination event listeners
    function setupPaginationListeners() {
      ['', '-bottom'].forEach(suffix => {
        document.getElementById(`first-page${suffix}`).addEventListener('click', () => goToPage(1));
        document.getElementById(`prev-page${suffix}`).addEventListener('click', () => goToPage(currentPage - 1));
        document.getElementById(`next-page${suffix}`).addEventListener('click', () => goToPage(currentPage + 1));
        document.getElementById(`last-page${suffix}`).addEventListener('click', () => goToPage(totalPages));
      });
    }

    function goToPage(page) {
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      displayCurrentPage();
      updatePaginationButtons();
    }
    function sortResultsByDate(data) {
    // Replace null with "N/A" and sort by "Last Modified" date
    data.forEach(row => {
      if (!row.lastmod) {
        row.lastmod = "N/A";
      }
    });

    data.sort((a, b) => {
      if (a.lastmod === "N/A") return 1; // Push "N/A" to the end
      if (b.lastmod === "N/A") return -1;
      return new Date(b.lastmod) - new Date(a.lastmod); // Sort descending by date
    });

    return data;
  }
  function displayResults(data) {
    const resultsDiv = document.getElementById("results");
    const summaryDiv = document.getElementById("results-summary");
    const hideUnknownContainer = document.getElementById("hide-unknown-container"); // Define the container

    currentResults = sortResultsByDate(data);

    // Calculate pagination
    totalPages = Math.ceil(data.length / itemsPerPage);
    currentPage = 1;

    // Show summary
    summaryDiv.innerHTML = `
      <strong>Results Summary:</strong><br>
      Found ${data.length.toLocaleString()} URLs total<br>
      Showing ${itemsPerPage} results per page
    `;
    resultsDiv.style.display = "block";
    hideUnknownContainer.style.display = "block"; // Show the checkbox container

    // Attach the event handler for the checkbox
    document.getElementById("hide-unknown").addEventListener("change", function () {
      displayCurrentPage();
    });

    displayCurrentPage();
    updatePaginationButtons();
  }

    function displayCurrentPage() {
      const tableBody = document.getElementById("results-body");
      tableBody.innerHTML = "";

      if (!currentResults || currentResults.length === 0) return;
      const hideUnknown = document.getElementById("hide-unknown").checked;

      // Calculate start and end indices
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, currentResults.length);
      const pageData = currentResults.slice(startIndex, endIndex);

      // Populate table
      pageData.forEach(row => {
        if (hideUnknown && row.lastmod === "N/A") {
          return; // Skip rows with "N/A" if the checkbox is checked
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.site || "Unknown"}</td>
          <td><a href="${row.url}" target="_blank" title="${row.url}">${row.url}</a></td>
          <td>${row.lastmod}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    function updatePaginationButtons() {
      const startItem = (currentPage - 1) * itemsPerPage + 1;
      const endItem = Math.min(currentPage * itemsPerPage, currentResults.length);
      
      ['', '-bottom'].forEach(suffix => {
        // Update page info
        document.getElementById(`page-info${suffix}`).textContent = 
          `Page ${currentPage} of ${totalPages} (${startItem.toLocaleString()}-${endItem.toLocaleString()} of ${currentResults.length.toLocaleString()})`;
        
        // Update button states
        document.getElementById(`first-page${suffix}`).disabled = currentPage === 1;
        document.getElementById(`prev-page${suffix}`).disabled = currentPage === 1;
        document.getElementById(`next-page${suffix}`).disabled = currentPage === totalPages;
        document.getElementById(`last-page${suffix}`).disabled = currentPage === totalPages;
      });
    }

    // Initialize pagination listeners
    setupPaginationListeners();
</script>
</body>
</html>